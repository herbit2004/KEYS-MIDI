<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟MIDI键盘</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <!-- 引入Tone.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // 设置Tone.js的延迟提示以优化交互响应
        Tone.context.latencyHint = "interactive";
    </script>
</head>
<body>
    <div class="midi-keyboard">
        <!-- 顶部控制区域 -->
        <div class="top-panel">
            <div class="logo-section">
                <h1>KEYS-MIDI</h1>
            </div>
            
            <!-- 帮助按钮和主显示屏容器 -->
            <div class="display-container">
                <!-- 帮助按钮 -->
                <button id="help-button" class="help-button">
                    <span class="help-icon">?</span>
                </button>
                <!-- 主显示屏 -->
                <div class="main-display">
                    <div class="display-content">PATCH-01</div>
                </div>
            </div>
            
            <!-- 帮助窗口 -->
            <div id="help-modal" class="help-modal">
                <div class="help-modal-content">
                    <span class="close-button">&times;</span>
                    <div class="help-panel" id="help-panel">
            <h3>使用说明:</h3>
            
            <h4>键盘演奏</h4>
            <ul>
                <li>默认映射：使用 <kbd>tab</kbd> <kbd>1</kbd> <kbd>q</kbd> <kbd>2</kbd> <kbd>w</kbd> <kbd>e</kbd> <kbd>4</kbd> <kbd>r</kbd> <kbd>5</kbd> <kbd>t</kbd> <kbd>6</kbd> <kbd>y</kbd> <kbd>u</kbd> <kbd>8</kbd> <kbd>i</kbd> <kbd>9</kbd> <kbd>o</kbd> <kbd>p</kbd> <kbd>-</kbd> <kbd>[</kbd> <kbd>=</kbd> <kbd>]</kbd> <kbd>backspace</kbd> <kbd>\</kbd> <kbd>z</kbd> <kbd>s</kbd> <kbd>x</kbd> <kbd>d</kbd> <kbd>c</kbd> <kbd>v</kbd> <kbd>g</kbd> <kbd>b</kbd> <kbd>h</kbd> <kbd>n</kbd> <kbd>j</kbd> <kbd>m</kbd> <kbd>,</kbd> <kbd>l</kbd> <kbd>.</kbd> <kbd>;</kbd> <kbd>/</kbd> 等键演奏</li>
                <li>替代映射：使用 <kbd>z</kbd> <kbd>s</kbd> <kbd>x</kbd> <kbd>d</kbd> <kbd>c</kbd> <kbd>v</kbd> <kbd>g</kbd> <kbd>b</kbd> <kbd>h</kbd> <kbd>n</kbd> <kbd>j</kbd> <kbd>m</kbd> <kbd>,</kbd> <kbd>l</kbd> <kbd>.</kbd> <kbd>;</kbd> <kbd>/</kbd> <kbd>tab</kbd> <kbd>1</kbd> <kbd>q</kbd> <kbd>2</kbd> <kbd>w</kbd> <kbd>e</kbd> <kbd>3</kbd> <kbd>r</kbd> <kbd>4</kbd> <kbd>t</kbd> <kbd>5</kbd> <kbd>y</kbd> <kbd>u</kbd> <kbd>6</kbd> <kbd>i</kbd> <kbd>7</kbd> <kbd>o</kbd> <kbd>8</kbd> <kbd>p</kbd> <kbd>[</kbd> <kbd>=</kbd> <kbd>]</kbd> <kbd>\</kbd> <kbd>backspace</kbd> 等键演奏</li>
                <li>支持多键同时按下演奏和弦</li>
                <li>按住<kbd>空格键</kbd>作为延音踏板</li>
                <li>支持两种键盘映射模式，可通过映射选择按钮切换</li>
            </ul>
            
            <h4>转调控制</h4>
            <ul>
                <li><kbd>↑</kbd> 升高八度 | <kbd>↓</kbd> 降低八度</li>
                <li><kbd>←</kbd> 升高半音 | <kbd>→</kbd> 降低半音</li>
                <li>通过界面中的<kbd>+</kbd>/<kbd>-</kbd>按钮调整八度和半音转调</li>
                <li>使用<kbd>RESET</kbd>按钮重置所有转调设置</li>
            </ul>
            
            <h4>音色控制</h4>
            <ul>
                <li>通过顶部<kbd>TONE</kbd>下拉菜单切换音色，支持钢琴、吉他等多种音色</li>
                <li>界面中提供了多种音色选择</li>
            </ul>
            
            <h4>MIDI编辑器</h4>
            <ul>
                <li>点击<kbd>录制</kbd>按钮开始录制演奏</li>
                <li>点击<kbd>播放</kbd>按钮回放录制内容</li>
                <li>点击<kbd>停止</kbd>按钮停止播放或录制</li>
                <li>点击<kbd>暂停</kbd>按钮暂停播放</li>
                <li>点击<kbd>保存</kbd>按钮导出MIDI文件</li>
                <li>点击<kbd>导入</kbd>按钮加载MIDI文件</li>
                <li>点击<kbd>全屏</kbd>按钮进入/退出全屏编辑模式</li>
                <li>在画布上点击音符可选中，按住<kbd>Ctrl</kbd>可多选</li>
                <li>拖拽选中音符可移动位置或调整长度</li>
                <li>使用<kbd>Ctrl+C</kbd>/<kbd>Ctrl+X</kbd>/<kbd>Ctrl+V</kbd>复制/剪切/粘贴音符</li>
                <li>选中音符后使用方向键微调位置</li>
                <li>按<kbd>Delete</kbd>键删除选中音符</li>
                <li>选中音符后在音符上滚动鼠标滚轮可调整音符力度</li>
                <li>按住<kbd>Ctrl</kbd>滚动滚轮可缩放时间轴</li>
                <li>按住<kbd>Ctrl+Shift</kbd>滚动滚轮可调整画布高度</li>
                <li>在空白区域拖拽可框选多个音符</li>
                <li>点击播放头可改变播放位置</li>
                <li>通过BPM输入框调整播放速度</li>
                <li>通过拍/小节输入框调整每小节拍数</li>
                <li>通过节拍器开关控制节拍器启停</li>
                <li>通过自动吸附开关控制音符吸附到网格</li>
                <li>支持调整节拍器音量和吸附灵敏度</li>
                <li>支持一键吸附触发和一键吸附时长功能</li>
            </ul>
            
            <h4>效果器控制</h4>
            <ul>
                <li>点击旋钮选中后，滚动鼠标滚轮调整参数</li>
                <li>支持调整延迟时间、延迟反馈、混响衰减、混响强度和全局音量</li>
            </ul>
        </div>
                </div>
            </div>
        </div>
        

        
        <!-- 键盘控制区域 -->
        
        <!-- MIDI编辑器区域 -->
        <div class="midi-editor-container">
            <div class="midi-editor-controls">
                <!-- 播放控制按钮组 -->
                <div class="control-group">
                    <button id="record-button-editor" class="midi-editor-button">
                        <img src="icons/record.svg" alt="录制">
                    </button>
                    <button id="stop-button-editor" class="midi-editor-button" style="display: none;">
                        <img src="icons/stop.svg" alt="停止">
                    </button>
                    <button id="play-button-editor" class="midi-editor-button">
                        <img src="icons/play.svg" alt="播放">
                    </button>
                    <button id="pause-button-editor" class="midi-editor-button" style="display: none;">
                        <img src="icons/pause.svg" alt="暂停">
                    </button>
                </div>
                
                <!-- BPM、拍/小节、节拍器和自动吸附控制组 -->
                <div class="control-group">
                    <!-- BPM 输入框 -->
                    <div class="bpm-control">
                        <label for="bpm-input">BPM:</label>
                        <input type="number" id="bpm-input" class="bpm-input" min="20" max="300" value="120">
                    </div>
                    <!-- 每小节拍数输入框 -->
                    <div class="beats-per-measure-control">
                        <label for="beats-per-measure-input">拍/小节:</label>
                        <input type="number" id="beats-per-measure-input" class="beats-per-measure-input" min="0" max="10" value="4">
                    </div>
                    <!-- 节拍器开关 -->
                <div class="metronome-control">
                    <button class="midi-editor-button metronome-snap-button">
                        <img src="icons/metronome.svg" alt="节拍器" id="metronome-icon" class="control-icon">
                    </button>
                    <!-- 节拍器音量控制栏 -->
                <div class="control-slider-container" id="metronome-volume-container" style="display: none;">
                    <div class="slider-description">节拍器音量</div>
                    <div class="slider-value" id="metronome-volume-value">-25 dB</div>
                    <input type="range" id="metronome-volume" class="control-slider" min="-60" max="0" value="-25" step="1">
                </div>
                </div>
                <!-- 自动吸附开关 -->
                <div class="snap-control">
                    <button class="midi-editor-button metronome-snap-button">
                        <img src="icons/snap.svg" alt="自动吸附" id="snap-icon" class="control-icon">
                    </button>
                    <!-- 自动吸附灵敏度控制栏 -->
                <div class="control-slider-container" id="snap-sensitivity-container" style="display: none;">
                    <div class="slider-description">吸附灵敏度</div>
                    <div class="slider-value" id="snap-sensitivity-value">15</div>
                    <input type="range" id="snap-sensitivity" class="control-slider" min="0" max="50" value="15" step="1">
                    <!-- 新增吸附精度选择 -->
                    <div class="snap-precision-control">
                        <div class="slider-description">吸附精度</div>
                        <div class="slider-value" id="snap-precision-value">1/1</div>
                        <input type="range" id="snap-precision" class="control-slider" min="1" max="10" value="1" step="1">
                    </div>
                    <!-- 一键吸附触发按钮 -->
                    <button id="snap-all-button" class="midi-editor-button" style="margin-top: 10px; width: 100%;">一键吸附触发</button>
                    <!-- 一键吸附时长按钮 -->
                    <button id="snap-duration-button" class="midi-editor-button" style="margin-top: 10px; width: 100%;">一键吸附时长</button>
                </div>
                </div>
                </div>
                
                <!-- 文件操作组 -->
                <div class="control-group">
                    <button id="save-button-editor" class="midi-editor-button export-import-button">
                        <img src="icons/export.svg" alt="保存">
                    </button>
                    <button id="load-button-editor" class="midi-editor-button export-import-button">
                        <img src="icons/import.svg" alt="导入">
                    </button>
                </div>
                
                <!-- 全屏按钮 -->
                <button id="fullscreen-button" class="midi-editor-button fullscreen-button">
                    <img src="icons/fullscreen.svg" alt="全屏">
                </button>
                
                <!-- 预加载fullscreen-exit.svg用于JavaScript切换 -->
                <img src="icons/fullscreen-exit.svg" alt="" style="display: none;">
                <input type="file" id="load-file-input" accept=".json" style="display: none;">
            </div>
            <div class="midi-editor-wrapper">
                <div class="midi-editor-track">
                    <div class="canvas-container">
                        <canvas id="midi-editor"></canvas>
                        <div class="midi-editor-playhead" id="playhead"></div>
                    </div>
                </div>
            </div>
            <!-- MIDI编辑器信息显示区域 -->
            <div class="midi-editor-info">
                <div class="playhead-info">播放头位置: <span id="playhead-position">0.00</span>s / <span id="track-duration">0.00</span>s</div>
                <div class="bpm-info">BPM: <span id="bpm-display">120</span></div>
                <div class="selected-notes-info" id="selected-notes-info">
                    <!-- 选中音符信息将在这里显示 -->
                </div>
            </div>
        </div>
        
        <!-- 键盘区域 -->
        <div class="keyboard-container">
            <!-- 映射选择功能 -->
            <div class="mapping-selector">
                <!-- 音色选择器 -->
                <div class="tone-selector">
                    <select id="tone-select" class="tone-select">
                        <option value="piano">Piano</option>
                        <option value="guitar">Guitar</option>
                        <option value="electricGuitar">Electric Guitar</option>
                        <option value="acousticBass">Acoustic Bass</option>
                        <option value="uprightBass">Upright Bass</option>
                    </select>
                    <div class="knob-label">TONE</div>
                </div>
                
                <!-- 八度控制 -->
                <div class="octave-controls">
                    <button id="octave-down" class="octave-button">-</button>
                    <div class="octave-display">OCT<span id="octave-shift">0</span></div>
                    <button id="octave-up" class="octave-button">+</button>
                </div>
                
                <!-- 转调控制 -->
                <div class="transpose-controls">
                    <button id="transpose-down" class="transpose-button">-</button>
                    <div class="transpose-display">TR<span id="key-turning">0</span></div>
                    <button id="transpose-up" class="transpose-button">+</button>
                </div>
                
                <!-- 重置按钮 -->
                <button id="reset" class="reset-button">RESET</button>
                
                <!-- 映射选择 -->
                <div class="choice-chips">
                    <input type="radio" id="default-mapping" name="key-mapping" value="default" checked>
                    <label for="default-mapping" class="chip">映射一</label>
                    
                    <input type="radio" id="alternative-mapping" name="key-mapping" value="alternative">
                    <label for="alternative-mapping" class="chip">映射二</label>
                </div>
            </div>
            <canvas id="keyboard" width="880" height="200"></canvas>
        </div>
        
        <!-- 全局效果器控制区 -->
        <div class="control-panel">
            <div class="control-section">
                <h3>全局效果</h3>
                <div class="knobs-row">
                    <div class="knob-item" data-param="delay-time" data-min="0.1" data-max="1" data-step="0.1" data-value="0.2">
                        <div class="knob-container">
                            <div class="knob"></div>
                        </div>
                        <div class="knob-label">延迟时间</div>
                        <div class="knob-value">0.2s</div>
                    </div>
                    <div class="knob-item" data-param="delay-feedback" data-min="0" data-max="0.9" data-step="0.1" data-value="0.1">
                        <div class="knob-container">
                            <div class="knob"></div>
                        </div>
                        <div class="knob-label">延迟反馈</div>
                        <div class="knob-value">0.1</div>
                    </div>
                    <div class="knob-item" data-param="reverb-decay" data-min="1" data-max="5" data-step="0.5" data-value="2">
                        <div class="knob-container">
                            <div class="knob"></div>
                        </div>
                        <div class="knob-label">混响衰减</div>
                        <div class="knob-value">2s</div>
                    </div>
                    <div class="knob-item" data-param="reverb-wet" data-min="0" data-max="1" data-step="0.1" data-value="0.3">
                        <div class="knob-container">
                            <div class="knob"></div>
                        </div>
                        <div class="knob-label">混响强度</div>
                        <div class="knob-value">0.3</div>
                    </div>
                    <div class="knob-item" data-param="master-volume" data-min="0" data-max="100" data-step="1" data-value="60">
                        <div class="knob-container">
                            <div class="knob"></div>
                        </div>
                        <div class="knob-label">全局音量</div>
                        <div class="knob-value">60%</div>
                    </div>
                </div>
            </div>
        </div>
        

        

    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="js/main.js" type="module"></script>
    <script src="js/VisualManager.js" type="module"></script>
    <script>
        // 初始化Tone.js音频上下文
        document.addEventListener('click', function() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
        });
    </script>
</body>
</html>